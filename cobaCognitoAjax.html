<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="author" content="">
		<meta name="version" content="Bootstrap 3.3.5">
		<title>Portal Coba AWS JS</title>

		<link href="styles/bootstrap.min.css" rel="stylesheet">
		<link href="styles/bootstrap-extended.css" rel="stylesheet">
		<link href="styles/bootstrap-extended-theme.css" rel="stylesheet">

		<!-- [if lt IE 9]>
			<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif] -->
		
		<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
		<link rel="icon" href="images/favicon.ico">

		<script id="digits-sdk" src="https://cdn.digits.com/1/sdk.js" async></script>

	</head>
	<body>

		<div id="identityId"></div>
		<br/>
		<br/>
		<div id="token"></div>
		<br/>
		<br/>


		<div id="status"></div>
		<br/>
		<br/>

		<ul id="objects"></ul>
		<br/>
		<br/>

		<input type="file" id="file-chooser" /> 
		<button id="upload-button">Upload to S3</button>
		<br/>
		<br/>

		<div id="results"></div>



		<script src="scripts/jquery-2.1.4.min.js"></script>
		<script src="scripts/bootstrap.min.js"></script>
		<script src="scripts/bootstrap-extended.js"></script>
		<script src="scripts/aws-sdk-2.1.44.min.js"></script>
		<script src="portal/js/coba_common.js"></script>

<script type="text/javascript">

	function parseToken(kosong, data){
		if(data){
			console.log(data);

			document.getElementById('identityId').innerHTML = data.identityId;
			document.getElementById('token').innerHTML = data.token;
			
			AWS.config.region = 'us-east-1';
			AWS.config.logger = console;

		 	AWS.config.credentials = new AWS.CognitoIdentityCredentials({
//		        AccountId: '426588886354',
		        IdentityPoolId: 'us-east-1:b224255c-d08c-4532-b2d1-ff9cf734eaa6',
//		        RoleArn: 'arn:aws:iam::426588886354:role/Cognito_identityPoolPertamaAuth_Role',
		        IdentityId : 'us-east-1:067e98fb-a231-4e0b-a5d4-5bb5882ce7d9',
		        Logins: { 
				    'cognito-identity.amazonaws.com' : data.token
				}
		    });
		
		 	
			var bucket = new AWS.S3(
					{
						params: {Bucket: 'jcha'}
					}
				);
				bucket.listObjects(function (err, data) {
					if (err) {
						document.getElementById('status').innerHTML = 'Could not load objects from S3';
					} else {
						document.getElementById('status').innerHTML = 'Loaded ' + data.Contents.length + ' items from S3';
						for (var i = 0; i < data.Contents.length; i++) {
							document.getElementById('objects').innerHTML += '<li>' + data.Contents[i].Key + '</li>';
						}
					}
				}); // end bucket.listObjects
			  
				var fileChooser = document.getElementById('file-chooser');
				var button = document.getElementById('upload-button');
				var results = document.getElementById('results');

				button.addEventListener('click', function() {
					var file = fileChooser.files[0];
					if (file) {
						
						
						var identityId = "us-east-1:067e98fb-a231-4e0b-a5d4-5bb5882ce7d9";
						
						console.log(identityId);
						
						var params = 
						{
							Key: identityId+'/'+file.name, 
							ContentType: file.type, 
							Body: file
						};
						
						results.innerHTML = '';

		/* 					bucket.upload(params, function (err, data) {
							results.innerHTML = err ? 'ERROR!' : 'UPLOADED.';
							  
						});
		*/					
						
				        var req = bucket.putObject(params)
				        	.on('httpUploadProgress', function (progress) {
				            	console.log(progress);
				          	})
				          	.send(function (err, data) {
				            	console.log("FINISHED");
					            if (err) {
					              results.innerHTML += '<p>ERROR UPLOADING ' + files[i].name + '</p>';
					            } else {
					              var url = bucket.getSignedUrl('getObject', {Key: params.Key});
					              console.log(url)
					              results.innerHTML += '<img src="' + url + '">';
					            }
							}); // end .send
						
					} else {
						results.innerHTML = 'Nothing to upload.';
					} // end if file
				}, false); // end on click
		 
		 
		 	
		 	
		 	
		 	
		 	
		 	
		}
	}

	getData(portal.url_api+'getCognitoToken', 'GET', 'json', null, null, parseToken);

 
</script>

	</body>
</html>
